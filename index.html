<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale 语音牌组追踪器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #deck { border: 1px solid #ccc; padding: 10px; min-height: 100px; }
        button { margin: 5px; padding: 10px; }
        input { width: 200px; padding: 5px; }
    </style>
</head>
<body>
    <h1>Clash Royale 语音牌组追踪器</h1>
    
    <!-- 新增：手动输入窗口 -->
    <div>
        <label for="manualInput">手动输入卡牌名称：</label>
        <input type="text" id="manualInput" placeholder="e.g., archers">
        <button onclick="addCardFromInput()">添加卡牌</button>
    </div>
    
    <br>
    <button onclick="startListening()">开始语音识别</button>
    <button onclick="stopListening()">停止</button>
    <br><br>
    
    <div id="deck">当前牌组：</div>
    
    <script>
        let recognition;
        let currentDeck = [];
        let cardAliases = {}; // 卡牌别名映射
        
        // 加载卡牌别名（从原JSON）
        fetch('card_alias.json')
            .then(response => response.json())
            .then(data => {
                cardAliases = data;
                console.log('卡牌别名加载完成');
            })
            .catch(err => console.error('加载别名失败:', err));
        
        // 手动输入添加卡牌（新增功能）
        function addCardFromInput() {
            const input = document.getElementById('manualInput');
            const text = input.value.trim().toLowerCase();
            if (text) {
                const card = findCard(text);
                if (card && !currentDeck.includes(card)) {
                    currentDeck.push(card);
                    updateDeckDisplay();
                    input.value = '';
                } else {
                    alert('无效卡牌或已存在');
                }
            }
        }
        
        // 查找卡牌（原逻辑）
        function findCard(text) {
            for (let alias in cardAliases) {
                if (cardAliases[alias].includes(text)) {
                    return alias;
                }
            }
            return text; // 若无别名，直接使用
        }
        
        // 更新牌组显示（原逻辑）
        function updateDeckDisplay() {
            const deckDiv = document.getElementById('deck');
            deckDiv.innerHTML = '当前牌组：' + (currentDeck.length ? currentDeck.join(', ') : '空');
        }
        
        // 语音识别（修改为调用后端API）
        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];
                
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(chunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onload = async () => {
                        const base64Audio = reader.result.split(',')[1]; // base64数据
                        const response = await fetch('/recognize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ audio: base64Audio })
                        });
                        const result = await response.json();
                        if (result.text) {
                            const card = findCard(result.text.toLowerCase());
                            if (card && !currentDeck.includes(card)) {
                                currentDeck.push(card);
                                updateDeckDisplay();
                            }
                        }
                    };
                    reader.readAsDataURL(audioBlob);
                };
                
                mediaRecorder.start();
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                }, 5000); // 5秒录音
            } catch (err) {
                alert('录音失败: ' + err.message);
            }
        }
        
        function stopListening() {
            if (recognition) {
                recognition.stop();
            }
        }
        
        // 牌组满8张时重置（原逻辑，可选）
        window.addEventListener('beforeunload', () => {
            currentDeck = [];
        });
    </script>
</body>
</html>
